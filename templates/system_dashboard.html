{% extends "team_base.html" %}
{% block title %}System Dashboard - {{ system_name }}{% endblock %}
{% block content %}
<div class="mb-6">
  <a href="{{ url_for('team_admin_bom', team_number=team_number, robot_name=robot_name, system=system_name) }}"
     class="text-sm text-blue-300 hover:underline block mb-2">
    &larr; Back to System BOM
  </a>
  <h1 class="text-3xl font-bold text-white">‚öôÔ∏è System Dashboard: {{ system_name }}</h1>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
  <div>
    <canvas id="systemViewer" class="w-full h-96 rounded-lg border border-gray-600 shadow-lg bg-black"></canvas>
  </div>
  <div class="text-white space-y-4">
    <div class="text-xl font-semibold">üìä Process Progress</div>
    <div id="systemStats" class="text-gray-300 space-y-2">
      <!-- Stats populated via JS -->
    </div>
  </div>
</div>

<div id="confettiModal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-lg p-6 max-w-3xl w-full relative">
    <button onclick="document.getElementById('confettiModal').classList.add('hidden')"
            class="absolute top-2 right-3 text-xl text-gray-500 hover:text-black">&times;</button>
    <h2 class="text-2xl font-bold mb-4 text-center text-green-600">üéâ Finished Part!</h2>
    <canvas id="confettiViewer" class="w-full h-96 rounded border border-gray-300"></canvas>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
</script>
<script type="module">
import { showGLTFViewer } from "/static/js/gltf_viewer.js";

const teamNumber = "{{ team_number }}";
const robotName = "{{ robot_name }}";
const systemName = "{{ system_name }}";
const token = localStorage.getItem("jwt_token");

async function loadSystemStats() {
  const res = await fetch(`/api/dashboard/system_stats?team_number=${teamNumber}&robot_name=${robotName}&system_name=${systemName}`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const data = await res.json();
  if (!res.ok) return alert("Failed to load system stats");

  const el = document.getElementById("systemStats");
  el.innerHTML = `
    <div>Total Parts: <strong>${data.total_parts}</strong></div>
    <div>Completed: <strong>${data.completed_parts}</strong> (${data.percent_complete}%)</div>
    <div>COTS: ${data.cots_parts}, In-House: ${data.inhouse_parts}</div>
    <div>Top Process: ${data.top_process}</div>
  `;
}

async function showAssemblyViewer() {
  // 1. Fetch the GLTF for the system
  const res = await fetch('/api/viewer_gltf_batch', {
    method: 'POST',
    headers: {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      team_number: teamNumber,
      robot: robotName,
      system: systemName
    })
  });

  const blob = await res.blob();

// 2. Sanity check (not HTML error page)
  const text = await blob.text();
  if (text.startsWith("<") || text.includes("DOCTYPE") || text.includes("Error")) {
    console.error("‚ùå GLTF response is HTML or error:", text);
    return;
  }

  const fixedBlob = new Blob([text], { type: "model/gltf+json" });
  const url = URL.createObjectURL(fixedBlob);

// 3. Load it into the dashboard canvas
  showGLTFViewer(url, "systemViewer", false, false);

}

async function pollForFinishedParts() {
  const res = await fetch(`/api/dashboard/recent_completions?team_number=${teamNumber}&robot_name=${robotName}&system_name=${systemName}`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  if (!res.ok) return;
  const data = await res.json();
  const parts = Array.isArray(data.parts) ? data.parts : [];
  if (!parts.length) return;

  parts.sort((a, b) => new Date(b.ts) - new Date(a.ts));
  const part = parts[0];

  const gltfRes = await fetch("/api/viewer_gltf", {
    method: "POST",
    headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
    body: JSON.stringify({ team_number: teamNumber, robot: robotName, system: systemName, id: part.part_id })
  });
  if (!gltfRes.ok) return;
  const blob = await gltfRes.blob();
  const url = URL.createObjectURL(blob);

  document.getElementById("confettiModal").classList.remove("hidden");
  showGLTFViewer(url, "confettiViewer", true, true);
}
</script>
{% endblock %}
