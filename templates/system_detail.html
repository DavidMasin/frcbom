{% extends "team_base.html" %}
{% block title %}System BOM - {{ current_robot }} {{ filter_system }}{% endblock %}
{% block content %}

<div class="mb-6">
    <a href="{{ url_for('team_admin_robot', team_number=team_number, robot_name=current_robot) }}"
       class="text-sm text-blue-300 hover:underline">
        &larr; Back to {{ current_robot }} Details
    </a>
    <h1 class="text-3xl font-bold text-white mt-2">{{ filter_system }} BOM</h1>
</div>

<!-- ðŸ§¹ BOM Filter Buttons -->
<div class="mb-6">
    <div class="flex flex-wrap gap-2" id="filterButtons">
        <button class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-600" onclick="applyFilter(null)">All
            Parts
        </button>
        <button class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-600" onclick="applyFilter('COTS')">COTS
        </button>
        <button class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-600" onclick="applyFilter('InHouse')">
            In-House
        </button>
    </div>
</div>
<!-- ðŸ§² Material Download Dropdown -->
<div class="mb-6">
    <label for="materialDropdown" class="text-white font-semibold mr-2">Download All Material:</label>
    <select id="materialDropdown" onchange="downloadAllOfMaterial(this.value)" class="system-dropdown">
        <option value="">-- Select Material --</option>
    </select>
</div>

<!-- ðŸ¤© BOM Parts Section -->
<div class="mb-8">
    <h2 class="text-2xl font-bold text-gray-100 mb-4">Parts in {{ filter_system }}</h2>
    <div id="bomPartsGrid" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3"></div>
    <p id="noPartsMessage" class="text-center text-gray-500 mt-4">No parts to display.</p>
</div>

{% endblock %}
{% block scripts %}
<script>
    const token = localStorage.getItem("jwt_token");
    const teamNumber = "{{ team_number }}";
    const robotName = "{{ current_robot }}";
    const systemName = "{{ filter_system }}";
    let fullBOM = [];
    let currentFilter = null;
    let machineMap = {};

    function applyFilter(name) {
        currentFilter = name;
        renderBOM();
    }

    function getCurrentProcessStatus(part, qty) {
        const donePre = parseInt(part.done_preprocess || 0);
        const doneP1 = parseInt(part.done_process1 || 0);
        const doneP2 = parseInt(part.done_process2 || 0);
        const pp = part["Pre Process"]?.trim();
        const p1 = part["Process 1"]?.trim();
        const p2 = part["Process 2"]?.trim();

        if (pp && donePre < qty) return pp;
        if (p1 && (!pp || donePre >= qty) && doneP1 < qty) return p1;
        if (p2 && (!p1 || doneP1 >= qty) && doneP2 < qty) return p2;
        return null;
    }


    function getStatusColor(part, qty) {
        const donePre = parseInt(part.done_preprocess || 0);
        const doneP1 = parseInt(part.done_process1 || 0);
        const doneP2 = parseInt(part.done_process2 || 0);
        const pp = part["Pre Process"]?.trim();
        const p1 = part["Process 1"]?.trim();
        const p2 = part["Process 2"]?.trim();

        if (pp || p1 || p2) {
            if ((p2 && doneP2 >= qty) || (!p2 && p1 && doneP1 >= qty) || (!p2 && !p1 && donePre >= qty)) {
                return "bg-green-100";
            } else if (donePre > 0 || doneP1 > 0 || doneP2 > 0) {
                return "bg-yellow-100";
            }
        }
        return "bg-white";
    }

    function populateMaterialDropdown() {
        const dropdown = document.getElementById("materialDropdown");
        dropdown.innerHTML = `<option value="">-- Select Material --</option>`;

        const shownParts = fullBOM.filter(part => {
            const p1 = part["Process 1"]?.trim();
            const p2 = part["Process 2"]?.trim();
            const isCOTS = !part["Pre Process"] && !p1 && !p2;
            const isInHouse = !isCOTS;

            if (!currentFilter) return true;
            if (currentFilter === "COTS") return isCOTS;
            if (currentFilter === "InHouse") return isInHouse;
            return [part["Pre Process"], p1, p2].includes(currentFilter);
        });

        const materials = new Set();
        shownParts.forEach(part => {
            const mat = part.materialBOM || part.Material || null;
            if (mat) materials.add(mat.trim());
        });

        [...materials].sort().forEach(mat => {
            const option = document.createElement("option");
            option.value = mat;
            option.textContent = mat;
            dropdown.appendChild(option);
        });
    }

    async function downloadAllOfMaterial(materialName) {
        if (!materialName) return;

        const shownParts = fullBOM.filter(part => {
            const p1 = part["Process 1"]?.trim();
            const p2 = part["Process 2"]?.trim();
            const isCOTS = !part["Pre Process"] && !p1 && !p2;
            const isInHouse = !isCOTS;

            if (!currentFilter) return true;
            if (currentFilter === "COTS") return isCOTS;
            if (currentFilter === "InHouse") return isInHouse;
            return [part["Pre Process"], p1, p2].includes(currentFilter);
        });

        const filtered = shownParts.filter(p => {
            const mat = p.materialBOM || p.Material || "";
            return mat.trim() === materialName.trim();
        });

        for (const part of filtered) {
            const partId = part.partId;
            const qty = parseInt(part.Quantity || 1);
            const name = part["Part Name"]?.trim().replace(/[^a-zA-Z0-9-_]/g, "_") || "Unnamed";
            const mat = materialName.replace(/[^a-zA-Z0-9-_]/g, "_");
            const curProcess = getCurrentProcessStatus(part, qty);
            const fileType = (machineMap[curProcess] || "STEP").toUpperCase();

            const filename = `${name}x${qty}-${mat}.${fileType.toLowerCase()}`;

            fetch(`/api/download_cad`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    team_number: teamNumber,
                    robot: robotName,
                    system: systemName,
                    id: partId,
                    format: fileType
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.redirect_url) {
                        const link = document.createElement("a");
                        link.href = data.redirect_url;
                        link.target = "_blank";

                        // Try download with desired name using blob fallback
                        fetch(data.redirect_url)
                            .then(resp => {
                                if (!resp.ok) throw new Error("Unauthorized or failed");
                                return resp.blob();
                            })
                            .then(blob => {
                                const url = window.URL.createObjectURL(blob);
                                const a = document.createElement("a");
                                a.href = url;
                                a.download = filename;
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                window.URL.revokeObjectURL(url);
                            })
                            .catch(err => {
                                // Fallback: open in new tab if blob download fails
                                console.warn("ðŸŸ¡ Falling back to open in tab", err);
                                link.click();
                            });
                    } else {
                        alert(data.error || "Download failed");
                    }
                });
        }
    }

    function updateProcessQty(partId, key, newQty) {
        const part = fullBOM.find(p => p.partId === partId);
        if (part) part[key] = newQty;
        fetch("/api/save_bom_for_robot_system", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                team_number: teamNumber,
                robot_name: robotName,
                system_name: systemName,
                bom_data: fullBOM
            })
        });
    }

    function downloadPartCad(partId, fileType, partName = "Part") {
        if (!partId) return alert("Part ID missing");

        fetch(`/api/download_cad`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({
                team_number: teamNumber,
                robot: robotName,
                system: systemName,
                id: partId,
                format: fileType || "STEP"
            })
        })
            .then(res => res.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `${partName}.${fileType.toLowerCase()}`;  // âœ… filename based on part
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            })
            .catch(() => alert("Download failed"));
    }


    function renderCard(part) {
        const partId = part.partId;
        const qty = parseInt(part.Quantity || 0);
        const curProcess = getCurrentProcessStatus(part, qty);
        const bg = getStatusColor(part, qty);
        const p1 = part["Process 1"]?.trim();
        const p2 = part["Process 2"]?.trim();

        const fileType = machineMap[curProcess] || "STEP";
        const name = part["Part Name"] || "Unnamed";
        const mat = part.materialBOM || part.Material || "N/A";
        const desc = part.Description || "N/A";
        const donePre = part.done_preprocess || 0;
        const doneP1 = part.done_process1 || 0;
        const doneP2 = part.done_process2 || 0;
        const avail = part.available_qty || 0;

        const isCOTS = !part["Pre Process"] && !p1 && !p2;
        const isInHouse = !isCOTS;

        return `
        <div class="rounded border shadow-md p-4 relative hover:shadow-lg transition ${bg}">
            <h3 class="text-lg font-bold text-blue-700">${name}</h3>
            <p><strong>Material:</strong> ${mat}</p>
            <p><strong>Description:</strong> ${desc}</p>
            <p><strong>Quantity Needed:</strong> ${qty}</p>
            ${isInHouse && curProcess ? `<p class="text-sm text-gray-600 italic">ðŸ”§ Current Process: ${curProcess}</p>` : ""}
            ${part["Pre Process"] ? `<label>âœ… Done ${part["Pre Process"]}: <input type="number" value="${donePre}" onchange="updateProcessQty('${partId}', 'done_preprocess', this.value)" class="border px-2 py-1 rounded w-20" /></label><br/>` : ""}
            ${p1 ? `<label>âœ… Done ${p1}: <input type="number" value="${doneP1}" onchange="updateProcessQty('${partId}', 'done_process1', this.value)" class="border px-2 py-1 rounded w-20" /></label><br/>` : ""}
            ${p2 ? `<label>âœ… Done ${p2}: <input type="number" value="${doneP2}" onchange="updateProcessQty('${partId}', 'done_process2', this.value)" class="border px-2 py-1 rounded w-20" /></label><br/>` : ""}
            ${isCOTS ? `<label>ðŸ“¦ Qty In Stock: <input type="number" value="${avail}" onchange="updateProcessQty('${partId}', 'available_qty', this.value)" class="border px-2 py-1 rounded w-20" /></label>` : ""}
            <button title="Download CAD" class="absolute top-2 right-2 text-blue-600 hover:text-blue-900" onclick="downloadPartCad('${partId}', '${fileType}')">
                <i class="fas fa-download fa-lg"></i>
            </button>
        </div>
    `;
    }

    function renderBOM() {
        const grid = document.getElementById("bomPartsGrid");
        const noMsg = document.getElementById("noPartsMessage");
        grid.innerHTML = '';

        const shownParts = fullBOM
            .filter(part => {
                const p1 = part["Process 1"]?.trim();
                const p2 = part["Process 2"]?.trim();
                const isCOTS = !part["Pre Process"] && !p1 && !p2;
                const isInHouse = !isCOTS;

                if (!currentFilter) return true;
                if (currentFilter === "COTS") return isCOTS;
                if (currentFilter === "InHouse") return isInHouse;
                return [part["Pre Process"], p1, p2].includes(currentFilter);
            })
            .sort((a, b) => (a["Part Name"] || "").localeCompare(b["Part Name"] || ""));

        shownParts.forEach(part => {
            grid.innerHTML += renderCard(part);
        });

        noMsg.style.display = shownParts.length === 0 ? "block" : "none";
        populateMaterialDropdown();
    }

    async function loadAndRenderBOM() {
        const res = await fetch(`/api/get_bom?team_number=${teamNumber}&robot=${robotName}&system=${systemName}`, {
            headers: {Authorization: `Bearer ${token}`}
        });
        const data = await res.json();
        if (!res.ok || !data.bom_data) return;
        fullBOM = data.bom_data;
        renderBOM();
        populateMaterialDropdown();
    }


    (async () => {
        const token = localStorage.getItem("jwt_token");
        const teamNumber = "{{ team_number }}";
        const response = await fetch(`/api/machines?team_number=${teamNumber}`, {
            headers: {Authorization: `Bearer ${token}`}
        });
        if (!response.ok) return;
        const data = await response.json();
        const filterDiv = document.getElementById("filterButtons");
        (data.machines || []).forEach(m => {
            const name = m.name.trim();
            const cadFormat = m.cad_format?.trim() || "STEP";  // âœ… Get CAD format
            machineMap[name] = cadFormat;                       // âœ… Set mapping
            const btn = document.createElement("button");
            btn.className = "bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-600";
            btn.innerText = name;
            btn.onclick = () => applyFilter(name);
            filterDiv.appendChild(btn);
        });
    })();


    document.addEventListener("DOMContentLoaded", loadAndRenderBOM);
</script>
{% endblock %}
